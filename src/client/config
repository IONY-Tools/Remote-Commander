import colorama
import sys
import os
import sqlite3
from colorama import Fore, Back
from utils.database import DBConnection

database = sqlite3.connect("databases\Remote-Commander.db")

commands = {
    "rc:user:create": {
        "callback": "create_user()",
        "description": "Creates a New User."
    },
    "rc:user:delete": {
        "callback": "delete_user()",
        "description": "Deletes a user."
    },
    "db:migrate": {
        "callback": "migrate_db()",
        "description": "Drops all tables and recreates them."
    }
}

def info(msg):
    print(Back.CYAN+Fore.WHITE+" INFO "+Fore.RESET+Back.RESET+" "+msg) 

def warning(msg):
    print(Back.YELLOW+Fore.WHITE+" WARNING "+Fore.RESET+Back.RESET+" "+msg) 

def error(msg):
    print(Back.RED+Fore.WHITE+" ERROR "+Fore.RESET+Back.RESET+" "+msg) 

def prompt(msg, default: str = None) -> str:
    endpart = Fore.WHITE+":"
    if default != None:
        endpart = Fore.WHITE+" ["+Fore.YELLOW+f"{default}"+Fore.WHITE+"]:"
    print(Fore.GREEN+msg+Fore.WHITE+endpart)
    result = input("> ")
    if result == "":
        if default == None:
            error("Fail!")
            exit()
        else: 
            result = default
    
    return result

def create_user():
    first_name = prompt("First Name", "Default")
    print("\n")
    last_name = prompt("Last Name", "User")
    print("\n")
    username = prompt("Username")
    print("\n")
    password = prompt("Password")
    print("\n")
    admin = prompt("Administrator", "N")
    exit()

def parse():
    args = sys.argv[1:]
    if len(args) == 0:
        categories = []
        for i in commands:
            name = i.split(":")[0]
            if name not in categories:
                categories.append(name)
        for i in categories:
            print(Fore.GREEN+i)
            for j in commands:
                if j.startswith(i):
                    print(Fore.YELLOW + "   " + j + " - " + commands[j]["description"] + Fore.RESET)

    else:
        try:
            eval(commands[args[0]]["callback"])
        except Exception as e:
            print(e)
            error("Command not found.")

def migrate_db():
    sql = "select 'drop table ' || name || ';' from sqlite_master where type = 'table';"
    database.cursor().execute(sql)
    database.commit()
    for file in os.listdir("./migrations"):
        if file.endswith("database-migration"):
            database.cursor().execute(open("./migrations/"+file, "r").read())
            database.commit()
            info("Migrated " + file)
    info("Successfully migrated the DB.")
parse()